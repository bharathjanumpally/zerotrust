services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: ztrl
      POSTGRES_PASSWORD: ztrl
      POSTGRES_DB: ztrl
    ports:
      - "5432:5432"
    volumes:
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

  opa:
    image: openpolicyagent/opa:0.63.0
    command: ["run", "--server", "--addr", "0.0.0.0:8181", "--log-format", "json", "--set", "decision_logs.console=true", "/policy/policy.rego"]
    ports:
      - "8181:8181"
    volumes:
      - ./policy:/policy:ro

  rl-engine:
    build:
      context: ./rl-engine
    ports:
      - "8000:8000"
    volumes:
      - ./rl-engine:/app

  control-plane:
    build:
      context: ./control-plane
    environment:
      DATABASE_URL: postgres://ztrl:ztrl@postgres:5432/ztrl
      RL_ENGINE_URL: http://rl-engine:8000
      OPA_URL: http://opa:8181
      PORT: 8080
    depends_on:
      - postgres
      - rl-engine
      - opa
    ports:
      - "8080:8080"
    volumes:
      - ./control-plane:/app
      - ./control-plane/node_modules:/app/node_modules
      - ./digital-twin:/digital-twin
    command: sh -lc "npm install && npm run start"

  ui-dashboard:
    build:
      context: ./ui-dashboard
    environment:
      VITE_API_BASE: http://localhost:8080
    ports:
      - "5173:5173"
    depends_on:
      - control-plane
    volumes:
      - ./ui-dashboard:/app
      - ./ui-dashboard/node_modules:/app/node_modules
    command: sh -lc "npm install && npm run dev -- --host 0.0.0.0 --port 5173"

volumes:
  control_plane_node_modules:
  ui_dashboard_node_modules: